services:
  # NOTE: DynamoDB has been moved to the main docker-compose.yml
  # If running this compose file standalone, uncomment the following section:
  #
  # dynamodb-local:
  #   image: amazon/dynamodb-local:latest
  #   container_name: delphi-dynamodb-local
  #   ports:
  #     - "8000:8000"
  #   command: "-jar DynamoDBLocal.jar -sharedDb -dbPath /home/dynamodblocal/data"
  #   volumes:
  #     - dynamodb-data:/home/dynamodblocal/data
  #   environment:
  #     - JAVA_OPTS=-Xmx1G
  #   networks:
  #     - delphi-network
  #   user: root

  # NOTE: We're using the Ollama service from the main docker-compose.yml
  # This section is commented out to avoid duplicate Ollama instances
  # If running this compose file standalone, uncomment this section:
  #
  # ollama:
  #   image: ollama/ollama:latest
  #   container_name: delphi-ollama
  #   ports:
  #     - "11434:11434"
  #   volumes:
  #     - ollama-models:/root/.ollama
  #   networks:
  #     - delphi-network
  #   command: serve
  #   restart: unless-stopped

  # Delphi Application
  delphi-app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: delphi-app
    # Note: When running with main docker-compose, the dependencies are handled there
    # depends_on is commented out since we're not managing the Ollama service here
    # depends_on:
    #   - ollama
    env_file:
      - ${DELPHI_ENV_FILE:-.env}
    environment:
     # PostgreSQL connection settings
      - DATABASE_URL=postgresql://${DATABASE_USER}:${DATABASE_PASSWORD}@${DATABASE_HOST}:${DATABASE_PORT}/${DATABASE_NAME}
      - DATABASE_SSL_MODE=${DATABASE_SSL_MODE}
      - DATABASE_POOL_SIZE=${DATABASE_POOL_SIZE}
      - DATABASE_MAX_OVERFLOW=${DATABASE_MAX_OVERFLOW}
      # Set Python path explicitly
      - PYTHONPATH=/app
      # DynamoDB settings - point to shared main service
      - DYNAMODB_ENDPOINT=http://host.docker.internal:8000
      - AWS_ACCESS_KEY_ID=dummy
      - AWS_SECRET_ACCESS_KEY=dummy
      - AWS_REGION=us-east-1
      # Ollama settings - configurable via environment variables
      - OLLAMA_MODEL=${OLLAMA_MODEL:-llama3.1:8b}
      - OLLAMA_HOST=http://host.docker.internal:11434  # Connect to Ollama on host network
      - LLM_PROVIDER=${LLM_PROVIDER:-ollama}
    ports:
      - "8080:8080"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - delphi-network
    volumes:
      - ./delphi_orchestrator.py:/app/delphi_orchestrator.py
      - ./create_dynamodb_tables.py:/app/create_dynamodb_tables.py
      - ./requirements.txt:/app/requirements.txt
      # Mount polismath and other Python modules directory
      - ./polismath:/app/polismath
      # Ensure the renamed math module is properly mounted
      - ./polismath/pca_kmeans_rep:/app/polismath/pca_kmeans_rep
      # Mount umap_narrative directory
      - ./umap_narrative:/app/umap_narrative
    # Command that runs the setup_ollama script first
    command: >
      bash -c "
      echo 'Ensuring dependencies are installed...' &&
      pip install --no-cache-dir fastapi==0.115.0 pydantic colorlog numpy pandas scipy scikit-learn &&
      echo 'PYTHONPATH=$PYTHONPATH' &&
      echo 'Installed packages:' &&
      pip list | grep fastapi &&
      echo 'Setting up Ollama model...' &&
      cd /app && chmod +x ./setup_ollama.sh && ./setup_ollama.sh &&
      echo 'Keeping container alive...' &&
      tail -f /dev/null
      "

volumes:
  dynamodb-data:
  ollama-models:

networks:
  delphi-network:
    driver: bridge
