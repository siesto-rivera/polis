# Topic-Based Moderation System for pol.is

## Overview

The Topic-Based Moderation System (TopicMod) is a powerful new feature that leverages hierarchical clustered topics generated by the Delphi pipeline to enable efficient comment moderation. Instead of moderating comments individually, moderators can now work with semantically grouped topics and apply bulk actions based on the UMAP proximity visualization.

## Architecture

### Backend Components

#### API Endpoints (`/api/v3/topicMod/`)

1. **GET /topics** - Retrieves topics with moderation status
   - Parameters: `report_id`, optional `job_id`
   - Returns: Topics organized by layer with moderation metadata

2. **GET /topics/:topicKey/comments** - Gets comments for a specific topic
   - Parameters: `report_id`, `topicKey`
   - Returns: List of comments with UMAP coordinates and moderation status

3. **POST /moderate** - Applies moderation actions
   - Body: `report_id`, `topic_key` OR `comment_ids`, `action`, `moderator`
   - Actions: `accept`, `reject`, `meta`
   - Supports both topic-level and individual comment moderation

4. **GET /proximity** - Retrieves UMAP coordinates for visualization
   - Parameters: `report_id`, `layer_id`
   - Returns: Comment positions for proximity-based moderation

5. **GET /stats** - Moderation statistics
   - Parameters: `report_id`
   - Returns: Counts of pending, accepted, rejected, and meta topics

#### Database Schema

##### DynamoDB Tables

- **Delphi_CommentClustersLLMTopicNames** (existing)
  - Contains topic names and metadata generated by LLM
  - Key: `conversation_id`, `topic_key`

- **Delphi_TopicModerationStatus** (new)
  - Tracks moderation decisions for topics
  - Key: `conversation_id`, `topic_key`
  - Attributes: `moderation_status`, `moderator`, `moderated_at`, `comment_count`

- **Delphi_CommentClusters** (existing/extended)
  - Contains comment-to-topic mappings with UMAP coordinates
  - Key: `conversation_id`, `topic_key`
  - Attributes: `comment_id`, `umap_x`, `umap_y`, `cluster_id`, `layer_id`

##### PostgreSQL Updates

The system updates the existing `comments` table in PostgreSQL:
- `mod`: Moderation status (-1=rejected, 0=meta, 1=accepted)
- `is_meta`: Boolean flag for meta comments

### Frontend Components

#### React Component Hierarchy

```
TopicModeration (index.js)
├── TopicTree (topic-tree.js)
│   ├── Layer selection
│   ├── Topic display with moderation controls
│   └── Bulk topic actions
├── TopicDetail (topic-detail.js)
│   ├── Comment list for specific topic
│   ├── Individual comment selection
│   └── Bulk comment actions
├── ProximityVisualization (proximity-visualization.js)
│   ├── UMAP scatter plot
│   ├── Cluster visualization
│   └── Interactive moderation
└── TopicStats (topic-stats.js)
    ├── Moderation progress tracking
    └── Statistics dashboard
```

#### Navigation Integration

The TopicMod system is integrated into the client-admin conversation management interface:
- New "Topic Mod" tab in the conversation admin sidebar
- Routes: `/m/:conversation_id/topics/*`
- Follows existing patterns from comment moderation

## Features

### Hierarchical Topic Organization

Topics are organized in hierarchical layers (0-2) representing different levels of granularity:
- **Layer 0**: Coarse-grained topics (broad themes)
- **Layer 1**: Medium granularity 
- **Layer 2**: Fine-grained topics (specific subtopics)

Moderators can view and work with any layer depending on their needs.

### Bulk Moderation Actions

#### Topic-Level Actions
- Accept/reject/mark as meta entire topics
- Automatically applies to all comments in the topic
- Maintains audit trail with moderator and timestamp

#### Comment-Level Actions
- Select multiple comments within a topic
- Apply bulk actions to selected comments
- Individual comment moderation when needed

### Proximity-Based Moderation

The UMAP visualization provides spatial understanding of comment relationships:
- Comments positioned by semantic similarity
- Visual clustering shows related content
- Color coding by moderation status
- Interactive selection and bulk actions

### Real-Time Statistics

Comprehensive statistics tracking:
- Total topics by status (pending, accepted, rejected, meta)
- Completion rate progress bars
- Visual progress indicators
- Historical moderation data

## Usage Workflow

### 1. Topic Generation (Prerequisites)

Before using TopicMod, ensure the Delphi pipeline has been run:

```bash
# Generate embeddings and clusters
python 500_generate_embedding_umap_cluster.py

# Generate topic names using LLM
python 600_generate_llm_topic_names.py

# Create visualizations
python 700_datamapplot_for_layer.py
```

### 2. Topic-Level Moderation

1. Navigate to **Topic Mod** in conversation admin
2. Select desired layer (0, 1, or 2)
3. Review topic names and sample comments
4. Apply bulk actions: Accept, Reject, or Mark as Meta
5. Use "View Comments" for detailed review

### 3. Comment-Level Moderation

1. Click "View Comments" on any topic
2. Review individual comments in the topic
3. Select specific comments using checkboxes
4. Apply bulk actions to selected comments
5. Use "Select All" for topic-wide actions

### 4. Proximity-Based Analysis

1. Switch to "Proximity Map" tab
2. Select layer for visualization
3. Observe comment clustering patterns
4. Identify outliers or problematic clusters
5. Use spatial relationships to inform moderation decisions

### 5. Progress Monitoring

1. View "Statistics" tab for overview
2. Track completion rates by status
3. Monitor moderation velocity
4. Generate reports for team coordination

## Integration with Existing Systems

### Comment Moderation
- TopicMod works alongside existing comment moderation
- Updates flow to traditional mod queue
- Maintains compatibility with Jigsaw Perspective API
- Preserves existing moderation workflows

### Delphi Pipeline
- Leverages existing topic generation infrastructure
- Uses established DynamoDB schema patterns
- Integrates with narrative report generation
- Compatible with batch processing workflows

### UMAP Visualization
- Built on existing EVōC clustering system
- Uses DataMapPlot visualization framework
- Maintains consistency with report visualizations
- Supports multi-layer analysis

## Performance Considerations

### Database Optimization
- DynamoDB queries optimized for conversation-level access
- PostgreSQL updates batched for efficiency
- Minimal impact on existing comment moderation performance
- Caching strategies for frequently accessed topics

### Frontend Performance
- Component-level loading states
- Incremental data fetching
- Efficient re-rendering with React hooks
- SVG-based visualizations for performance

### Scalability
- Designed to handle conversations with thousands of comments
- Layer-based organization reduces cognitive load
- Bulk operations minimize API calls
- Real-time polling with reasonable intervals

## Error Handling and Edge Cases

### Missing Topic Data
- Graceful fallback when Delphi data unavailable
- Clear messaging about pipeline requirements
- Fallback to traditional comment moderation

### Network Failures
- Retry mechanisms for failed requests
- Optimistic UI updates with rollback
- Clear error messaging and recovery options

### Data Consistency
- Atomic operations for topic-level moderation
- Transaction-like behavior for bulk actions
- Conflict resolution for concurrent moderation

## Security and Permissions

### Access Control
- Inherits existing conversation-level permissions
- Moderator role verification for all actions
- Audit trail for all moderation decisions

### Data Protection
- No additional PII exposure
- Secure API endpoints with parameter validation
- CORS and authentication following existing patterns

### Audit Trail
- All moderation actions logged with timestamp
- Moderator identity tracking
- Reversible actions where appropriate

## Future Enhancements

### Advanced Features
- Machine learning suggestions for topic categorization
- Automated pre-moderation based on topic patterns
- Integration with external content analysis APIs
- Custom topic naming and organization

### UI/UX Improvements
- Drag-and-drop topic organization
- Advanced filtering and search
- Customizable dashboards
- Mobile-responsive design

### Analytics Integration
- Topic-level engagement metrics
- Moderation efficiency tracking
- Bias detection and reporting
- A/B testing framework for moderation strategies

## Technical Requirements

### Server Dependencies
- Node.js with TypeScript support
- AWS SDK for DynamoDB access
- PostgreSQL client libraries
- Express.js framework

### Client Dependencies
- React with hooks support
- theme-ui for consistent styling
- React Router for navigation
- SVG manipulation for visualizations

### Infrastructure
- DynamoDB tables with appropriate indices
- PostgreSQL database with comment tables
- Redis cache for performance optimization (optional)
- CDN for static asset delivery

## Deployment Notes

### Development Setup
1. Ensure Delphi pipeline is configured
2. Create required DynamoDB tables
3. Update client-admin routing
4. Run both server and client builds

### Production Deployment
1. Deploy server with new API endpoints
2. Update client-admin bundle
3. Run database migrations if needed
4. Monitor performance and error rates

### Monitoring
- API endpoint response times
- DynamoDB read/write capacity
- PostgreSQL query performance
- Client-side error tracking

---

This documentation provides a comprehensive overview of the TopicMod system. For specific implementation details, refer to the source code in `/server/src/routes/delphi/topicMod.ts` and `/client-admin/src/components/conversation-admin/topic-moderation/`.