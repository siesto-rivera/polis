# S3 Storage for Delphi Visualizations

This document describes how Delphi visualization files are stored in S3-compatible storage.

## Overview

The Delphi pipeline generates HTML, PNG, and SVG visualization files that can be stored in S3-compatible storage. In local development, we use MinIO as an S3-compatible storage service. In production, we use AWS S3.

The visualization files are generated by the scripts in the `umap_narrative` directory:

- `700_datamapplot_for_layer.py`: Generates interactive HTML visualizations
- `701_static_datamapplot_for_layer.py`: Generates static PNG and SVG visualizations

Previously, these files were only saved to the local filesystem. Now, they are also uploaded to S3.

## Configuration

To use S3 storage, the following environment variables must be set:

```
AWS_S3_ENDPOINT=http://host.docker.internal:9000
AWS_ACCESS_KEY_ID=minioadmin
AWS_SECRET_ACCESS_KEY=minioadmin
AWS_S3_BUCKET_NAME=polis-delphi
AWS_REGION=us-east-1
```

For local development with MinIO, these are set in the `.env` file. For production, these should be set in the environment.

## Local Development with MinIO

For local development, we use MinIO as an S3-compatible storage service. MinIO is configured in the `docker-compose.yml` file.

To set up MinIO:

1. Start the docker containers:

   ```
   docker compose up -d
   ```

2. The MinIO server should be running on ports 9000 (API) and 9001 (Web UI).

3. Run the setup script to create the bucket:

   ```
   python delphi/setup_minio_bucket.py
   ```

4. You can access the MinIO web interface at http://localhost:9001 with the credentials:

   - Username: minioadmin
   - Password: minioadmin

5. To test S3 access, run:
   ```
   python delphi/test_minio_access.py
   ```

## File Storage Structure

Visualization files are stored in S3 with the following structure:

```
visualizations/{zid}/layer_{layer_id}_datamapplot.html
visualizations/{zid}/layer_{layer_id}_datamapplot_static.png
visualizations/{zid}/layer_{layer_id}_datamapplot_presentation.png
visualizations/{zid}/layer_{layer_id}_datamapplot_static.svg
```

Where:

- `{zid}` is the conversation ID
- `{layer_id}` is the layer ID (0, 1, 2, etc.)

## Accessing Visualization Files

In local development, you can access the files via the MinIO web interface at http://localhost:9001.

In the code, S3 URLs for stored visualizations are also saved to local files:

- `{zid}_layer_{layer_id}_s3_url.txt` for interactive visualizations
- `{zid}_layer_{layer_id}_s3_urls.json` for static visualizations

These local files contain the URLs that can be used to access the visualizations from the S3 storage.

## Production S3 Setup

For production, you'll need to:

1. Create an S3 bucket for Delphi visualizations.
2. Set up appropriate IAM policies to allow the Delphi service to write to the bucket.
3. Configure the environment variables to point to the production S3 bucket.

## Troubleshooting

If you encounter issues with S3 storage:

1. Check that the MinIO or S3 service is running and accessible.
2. Verify that the environment variables are set correctly.
3. Check for error messages in the Delphi logs.
4. Run the test script to verify connectivity: `python delphi/test_minio_access.py`
5. If using MinIO, check the MinIO web interface at http://localhost:9001 to see if the bucket exists.
6. If using AWS S3, check the AWS S3 console to see if the bucket exists and if the IAM permissions are set up correctly.
