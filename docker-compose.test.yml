# This file is an alternative to the original docker-compose.yml file.
# It is intended to be used for CI test workflows.
# DO NOT USE THIS IN PRODUCTION.

# Run with: `docker compose -f docker-compose.test.yml --env-file test.env up --build`.

services:
  client-participation-alpha:
    build:
      context: ./client-participation-alpha
      dockerfile: Dockerfile
      args:
        - OIDC_CACHE_KEY_ID_TOKEN_SUFFIX=${OIDC_CACHE_KEY_ID_TOKEN_SUFFIX}
        - OIDC_CACHE_KEY_PREFIX=${OIDC_CACHE_KEY_PREFIX}
        - PUBLIC_SERVICE_URL=${PUBLIC_SERVICE_URL}
    depends_on:
      - "server"
    environment:
      - INTERNAL_SERVICE_URL=${INTERNAL_SERVICE_URL}
      - PUBLIC_OIDC_CACHE_KEY_ID_TOKEN_SUFFIX=${OIDC_CACHE_KEY_ID_TOKEN_SUFFIX}
      - PUBLIC_OIDC_CACHE_KEY_PREFIX=${OIDC_CACHE_KEY_PREFIX}
      - PUBLIC_SERVICE_URL=${PUBLIC_SERVICE_URL}
    networks:
      - polis-test
    ports:
      - "4321:4321"
    restart: unless-stopped

  server:
    environment:
      - DATABASE_SSL=false
      - DATABASE_URL=${DATABASE_URL}
      - MAILDEV_HOST=maildev
      - NODE_ENV=development
      - NODE_EXTRA_CA_CERTS=/root/.simulacrum/certs/rootCA.pem
    env_file:
      - test.env
    build:
      context: ./server
      dockerfile: Dockerfile
      target: prod
      args:
        NODE_ENV: production
    labels:
      polis_tag: test
    networks:
      - polis-test
    volumes:
      # Mount mkcert root CA for TLS verification
      - ${AUTH_CERTS_PATH:-~/.simulacrum/certs}:/root/.simulacrum/certs:ro
    restart: unless-stopped
    depends_on:
      - oidc-simulator
      - postgres
    extra_hosts:
      - "host.docker.internal:host-gateway"

  math:
    build:
      context: ./math
    labels:
      polis_tag: test
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - LOGGING_LEVEL=${MATH_LOG_LEVEL:-warn}
      - MATH_ENV=${MATH_ENV:-prod}
      - WEBSERVER_USERNAME=${WEBSERVER_USERNAME}
      - WEBSERVER_PASS=${WEBSERVER_PASS}
    networks:
      - polis-test
    restart: unless-stopped
    extra_hosts:
      - "host.docker.internal:host-gateway"

  maildev:
    image: docker.io/maildev/maildev:1.1.1
    labels:
      polis_tag: test
    networks:
      - polis-test
    ports:
      # User interface
      - "1080:1080"
      # SMTP port
      - "1025:1025"

  oidc-simulator:
    build:
      context: ./oidc-simulator
      dockerfile: Dockerfile
    environment:
      - AUTH_AUDIENCE=users
      - AUTH_CLIENT_ID=dev-client-id
      - AUTH_NAMESPACE=https://pol.is/
      - AUTH_SIMULATOR_PORT=3000
      - CERT_DIR=/root/.simulacrum/certs
    labels:
      polis_tag: test
    networks:
      - polis-test
    ports:
      - 3000:3000
    volumes:
      - ${AUTH_CERTS_PATH:-~/.simulacrum/certs}:/root/.simulacrum/certs:ro

  postgres:
    build:
      context: ./server
      dockerfile: Dockerfile-db
      labels:
        polis_tag: test
    environment:
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_USER=${POSTGRES_USER}
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - polis-test
    ports:
      - 5432:5432
    restart: unless-stopped
    # PostgreSQL configuration for development/testing
    command: >
      postgres 
      -c max_connections=${POSTGRES_MAX_CONNECTIONS:-300}
      -c shared_buffers=256MB
      -c effective_cache_size=1GB
      -c work_mem=4MB
      -c maintenance_work_mem=64MB
      -c wal_buffers=16MB
      -c checkpoint_completion_target=0.9
      -c checkpoint_timeout=10min
      -c log_connections=on
      -c log_disconnections=on
      -c autovacuum=on
      -c autovacuum_max_workers=3
      -c autovacuum_naptime=30s

  nginx-proxy:
    build:
      context: ./file-server
      dockerfile: nginx.Dockerfile
    depends_on:
      - client-participation-alpha
      - server
    environment:
      - API_SERVER_PORT=5000
    labels:
      polis_tag: test
    networks:
      - polis-test
    ports:
      - 80:80
      - 443:443

  file-server:
    build:
      context: ./
      dockerfile: file-server/Dockerfile
      args:
        AUTH_AUDIENCE: users
        AUTH_CLIENT_ID: dev-client-id
        AUTH_ISSUER: https://localhost:3000/
        EMBED_SERVICE_HOSTNAME: localhost
        GIT_HASH: "${GIT_HASH:-placeholder}"
        NODE_ENV: production
        OIDC_CACHE_KEY_ID_TOKEN_SUFFIX: ${OIDC_CACHE_KEY_ID_TOKEN_SUFFIX}
        OIDC_CACHE_KEY_PREFIX: ${OIDC_CACHE_KEY_PREFIX}
    environment:
      - PORT=8080
    labels:
      polis_tag: test
    networks:
      - polis-test

  dynamodb:
    image: amazon/dynamodb-local:latest
    ports:
      - "8000:8000"
    networks:
      - polis-test
    environment:
      - JAVA_OPTS=-Xmx1G
    user: root
    labels:
      polis_tag: test
    extra_hosts:
      - "host.docker.internal:host-gateway"

networks:
  polis-test:
